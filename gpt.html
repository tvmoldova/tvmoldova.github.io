<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ультра Ловец M3U8 с Video.js</title>

<link href="https://unpkg.com/video.js@7/dist/video-js.min.css" rel="stylesheet" />

<style>
  body {
    background: #000;
    color: #fff;
    font-family: Arial,sans-serif;
    margin: 0; padding: 0;
  }
  #player-container {
    max-width: 800px;
    margin: 20px auto;
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
  }
  #videojs-player {
    position: absolute;
    top:0; left:0;
    width: 100%; height: 100%;
    display: none;
  }
  #status {
    text-align:center;
    margin-top: 20px;
    font-size: 18px;
  }
</style>

<script>
  (() => {
    const log = (...args) => console.log('[M3U8 Detector]', ...args);

    window.m3u8Url = null;
    window.m3u8Detected = false;

    function tryDetect(url) {
      if (!window.m3u8Detected && url && url.includes('.m3u8')) {
        window.m3u8Detected = true;
        window.m3u8Url = url;
        log('Пойман URL:', url);
        window.initVideoJS && window.initVideoJS();
      }
    }

    // Перехват fetch
    const origFetch = window.fetch;
    window.fetch = function (...args) {
      let url = args[0];
      if (typeof url === 'string') tryDetect(url);
      return origFetch.apply(this, args);
    };

    // Перехват XHR.open и XHR.send
    const origXHROpen = XMLHttpRequest.prototype.open;
    const origXHRSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function (method, url) {
      this._url = url; // запомним
      return origXHROpen.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function () {
      if (typeof this._url === 'string') tryDetect(this._url);
      return origXHRSend.apply(this, arguments);
    };

    // Перехват video.src
    const videoProto = HTMLVideoElement.prototype;
    const videoSrcDesc = Object.getOwnPropertyDescriptor(videoProto, 'src');
    if (videoSrcDesc && videoSrcDesc.set) {
      Object.defineProperty(videoProto, 'src', {
        set: function (val) {
          tryDetect(val);
          return videoSrcDesc.set.call(this, val);
        },
        get: videoSrcDesc.get,
        configurable: true
      });
    }

    // Перехват source.src
    const sourceProto = HTMLSourceElement.prototype;
    const sourceSrcDesc = Object.getOwnPropertyDescriptor(sourceProto, 'src');
    if (sourceSrcDesc && sourceSrcDesc.set) {
      Object.defineProperty(sourceProto, 'src', {
        set: function (val) {
          tryDetect(val);
          return sourceSrcDesc.set.call(this, val);
        },
        get: sourceSrcDesc.get,
        configurable: true
      });
    }

    // Перехват добавления атрибутов src через setAttribute (на всякий случай)
    const origSetAttribute = Element.prototype.setAttribute;
    Element.prototype.setAttribute = function (name, value) {
      if ((name === 'src' || name === 'SRC') && typeof value === 'string') {
        tryDetect(value);
      }
      return origSetAttribute.apply(this, arguments);
    };

    // Мониторинг добавления новых элементов <source> и <video>
    const observer = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
          if (node.tagName === 'SOURCE' && node.src) tryDetect(node.src);
          if (node.tagName === 'VIDEO' && node.src) tryDetect(node.src);
          // Можно расширить для вложенных элементов
        });
      });
    });
    observer.observe(document, { childList: true, subtree: true });

    // Performance API — на всякий пожарный, ловим все запросы после полной загрузки
    window.addEventListener('load', () => {
      const entries = performance.getEntriesByType('resource');
      entries.forEach(entry => {
        tryDetect(entry.name);
      });
    });
  })();
</script>
</head>
<body>

<div id="player-container">
  <div id="original-player">
    <!-- Здесь будет твой оригинальный плеер -->
    <p style="text-align:center; color:#666;">Оригинальный плеер работает...</p>
  </div>
  <video id="videojs-player" class="video-js vjs-default-skin" controls playsinline></video>
</div>

<div id="status">Ждём поток...</div>

<script src="https://unpkg.com/video.js@7/dist/video.min.js"></script>
<script src="https://unpkg.com/videojs-contrib-hls@5/dist/videojs-contrib-hls.min.js"></script>

<script>
  // Симуляция запуска оригинального плеера — замени на реальный
  function startOriginalPlayer() {
    // Тут реальный плеер будет загружать поток и делать запросы
    // Для примера имитируем fetch m3u8 через 2 секунды:
    setTimeout(() => {
      fetch('https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8');
      console.log('Имитация загрузки потока через fetch');
    }, 2000);
  }

  startOriginalPlayer();

  // Инициализация Video.js после ловли M3U8
  window.initVideoJS = function () {
    if (!window.m3u8Url) {
      console.error('M3U8 URL не найден!');
      return;
    }
    document.getElementById('status').textContent = 'M3U8 найден, запускаем Video.js...';

    // Удаляем оригинальный плеер
    const original = document.getElementById('original-player');
    original.innerHTML = '';

    const video = document.getElementById('videojs-player');
    video.style.display = 'block';

    const player = videojs('videojs-player', {
      fluid: true,
      autoplay: true,
      controls: true,
      playbackRates: [0.5, 1, 1.5, 2],
      sources: [{
        src: window.m3u8Url,
        type: 'application/x-mpegURL'
      }]
    });

    player.ready(() => {
      console.log('Video.js готов к воспроизведению');
      document.getElementById('status').textContent = 'Воспроизведение...';
    });
  };
</script>

</body>
</html>