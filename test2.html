<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.05, maximum-scale=1.05, user-scalable=no" />
<title>MDFM Radio Player</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
/* Все стили остаются без изменений */
:root {
  --bg-main: #121212;
  --bg-element: #1e1e1e;
  --bg-element-hover: #282828;
  --text-primary: #eaeaea;
  --text-secondary: #b3b3b3;
  --accent: #1DB954;
  --accent-hover: #1ed760;
  --border-color: #2c2c2c;
  --card-border: rgba(30, 215, 96, 0.27);
  --player-bg: #0a0a0a;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}
header {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  background: var(--bg-main);
  border-bottom: 1px solid var(--border-color);
  position: relative;
  z-index: 30;
  gap: 15px;
  width: 100%;
}
header h1 {
  font-size: 20px;
  font-weight: bold;
  color: var(--accent);
  white-space: nowrap;
}
.search {
  background: var(--bg-element);
  border-radius: 8px;
  padding: 8px 14px;
  flex: 1;
  display: flex;
  align-items: center;
  border: 1px solid var(--border-color);
  min-width: 0;
}
.search i {
  margin-right: 8px;
  color: var(--accent);
}
.search input {
  background: transparent;
  border: none;
  color: var(--text-primary);
  width: 100%;
  font-size: 14px;
  outline: none;
  user-select: auto;
  -webkit-user-select: auto;
  -moz-user-select: auto;
  -ms-user-select: auto;
}
.grid {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}
.card {
  background: var(--bg-element);
  border-radius: 10px;
  padding: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  position: relative;
  overflow: hidden;
  user-select: none;
  outline: none;
  contain: content;
  transition: none !important;
  border: 1px solid var(--card-border);
}
.card:hover, .card:active {
  background: var(--bg-element-hover) !important;
  border-color: var(--card-border) !important;
  transform: none !important;
  box-shadow: none !important;
}
.card .station-logo {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
}
.card .station-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
  pointer-events: none; /* Блокировка событий мыши */
}
.card .station-logo i {
  font-size: 16px;
  color: var(--accent);
}
.card .station-info {
  flex: 1;
  overflow: hidden;
  min-width: 0;
}
.card h3 {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-loader {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: #333;
  overflow: hidden;
}
.card-loader::before {
  content: '';
  position: absolute;
  height: 2px;
  width: 50%;
  background: var(--accent);
  animation: loading 1.5s infinite ease-in-out;
  backface-visibility: hidden;
}
@keyframes loading {
  0% { transform: translate3d(-100%, 0, 0); }
  100% { transform: translate3d(200%, 0, 0); }
}
#mini-player {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-element);
  border-top: 1px solid var(--border-color);
  padding: 10px 16px;
  display: none;
  justify-content: space-between;
  align-items: center;
  z-index: 25;
  width: 100%;
  box-sizing: border-box;
}
#mini-player .mini-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  overflow: hidden;
  min-width: 0;
}
#mini-player .mini-logo {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  overflow: hidden;
  flex-shrink: 0;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--card-border);
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
}
#mini-player .mini-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
  pointer-events: none; /* Блокировка событий мыши */
}
#mini-player .mini-logo i {
  color: var(--accent);
  font-size: 14px;
}
#mini-player .mini-title {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}
#mini-player .mini-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  gap: 0;
}
#mini-player .mini-play-toggle {
  background: var(--bg-element);
  border: 1px solid var(--accent);
  width: 35px;
  height: 35px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--accent);
  font-size: 13px;
  cursor: pointer;
  transform: translateZ(0);
  will-change: transform;
  transition: all 0.3s ease;
}
#mini-player .mini-play-toggle:hover {
  background: rgba(30, 215, 96, 0.1);
  box-shadow: 0 0 10px rgba(30, 215, 96, 0.3);
  transform: scale(1.1);
}
#player-fullscreen {
  position: fixed;
  inset: 0;
  background: var(--player-bg);
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 30px;
  z-index: 100;
  text-align: center;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#player-fullscreen .back {
  position: absolute;
  top: 20px;
  left: 0;
  right: 0;
  text-align: center;
  color: var(--accent);
  cursor: pointer;
  font-size: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  z-index: 10;
  transition: all 0.3s ease;
}
#player-fullscreen .back:hover {
  background: rgba(30, 215, 96, 0.1);
  box-shadow: 0 0 10px rgba(30, 215, 96, 0.3);
}
.player-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
  height: 100%;
  justify-content: space-around;
  padding: 20px 0;
  box-sizing: border-box;
}
.station-logo-large {
  width: 30vh;
  height: 30vh;
  max-width: 250px;
  max-height: 250px;
  min-width: 150px;
  min-height: 150px;
  border-radius: 16px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  border: 1px solid var(--accent);
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
}
.station-logo-large img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  /* Запрет на выделение и перетаскивание */
  -webkit-user-drag: none;
  user-select: none;
  pointer-events: none; /* Блокировка событий мыши */
}
.station-logo-large i {
  color: var(--accent);
  font-size: 50px;
}
#station-name {
  font-size: 24px;
  color: var(--text-primary);
  font-weight: 600;
  padding: 0 20px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.navigation-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 40px;
  width: 100%;
  max-width: 400px;
}
.navigation-controls .nav-button {
  font-size: 24px;
  color: var(--accent);
  cursor: pointer;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(30, 30, 30, 0.8);
  border: 1px solid var(--card-border);
  transform: translateZ(0);
  will-change: transform;
  transition: all 0.3s ease;
}
.navigation-controls .play-button {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 1px solid var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  background: var(--accent);
  cursor: pointer;
  transform: translateZ(0);
  will-change: transform;
  transition: all 0.3s ease;
}

/* --- ИСПРАВЛЕННЫЕ СТИЛИ ДЛЯ НАЖАТИЯ --- */

/* Этот стиль применяется JS в момент нажатия/касания */
.navigation-controls .nav-button.active-state {
  background: rgba(30, 215, 96, 0.2);
  box-shadow: 0 0 10px rgba(30, 215, 96, 0.3);
  transform: scale(1.1);
}
.navigation-controls .play-button.active-state {
  background: var(--accent-hover);
  box-shadow: 0 0 20px rgba(30, 215, 96, 0.4);
  transform: scale(1.05);
}

/* Этот стиль применяется ТОЛЬКО на устройствах с мышью при наведении */
@media (hover: hover) and (pointer: fine) {
  .navigation-controls .nav-button:hover {
    background: rgba(30, 215, 96, 0.2);
    box-shadow: 0 0 10px rgba(30, 215, 96, 0.3);
    transform: scale(1.1);
  }
  .navigation-controls .play-button:hover {
    background: var(--accent-hover);
    box-shadow: 0 0 20px rgba(30, 215, 96, 0.4);
    transform: scale(1.05);
  }
}

.volume-container {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 80%;
  max-width: 280px;
  margin: 20px 0;
}
.volume-container i {
  color: var(--accent);
  font-size: 20px;
  width: 24px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
.volume-slider {
  flex: 1;
  display: flex;
  align-items: center;
}
.volume-slider input[type="range"] {
  width: 100%;
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 5px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  transition: background 0.3s ease;
}
.volume-slider input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}
.volume-slider input[type="range"]::-webkit-slider-thumb:hover {
  background: var(--accent-hover);
  transform: scale(1.2);
}
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 20px;
  color: var(--accent);
}
.loading i {
  font-size: 40px;
  color: var(--accent);
  animation: spin 1.5s linear infinite;
  backface-visibility: hidden;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.error {
  padding: 20px;
  text-align: center;
  color: #ff6b6b;
}
.no-results {
  text-align: center;
  padding: 30px;
  color: var(--accent);
}
.custom-error {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(18, 18, 18, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
  backdrop-filter: blur(5px);
  opacity: 0;
  transition: opacity 0.3s ease;
}
.custom-error.show {
  display: flex;
  opacity: 1;
}
.custom-error-content {
  background: var(--bg-element);
  padding: 25px 30px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--accent);
  max-width: 90%;
  width: 380px;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}
.custom-error.show .custom-error-content {
    transform: scale(1);
}
.custom-error-content p {
  margin: 0;
  font-size: 16px;
  color: var(--text-primary);
  line-height: 1.5;
}
@media (prefers-reduced-motion: reduce) {
  * {
    animation: none !important;
    transition: none !important;
  }
  .card-loader::before {
    display: none;
  }
  .loading i {
    animation: none;
  }
  #mini-player .mini-play-toggle:hover,
  .navigation-controls .nav-button:hover,
  .navigation-controls .play-button:hover,
  .volume-slider input[type="range"]::-webkit-slider-thumb:hover {
    transform: none !important;
  }
}
@media (max-width: 768px) {
  .station-logo-large {
    width: 25vh;
    height: 25vh;
    max-width: 200px;
    max-height: 200px;
  }
  #station-name { font-size: 22px; }
  .navigation-controls { gap: 30px;
  }
  .navigation-controls .play-button {
    width: 70px;
    height: 70px;
    font-size: 24px;
  }
  .navigation-controls .nav-button {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
}
@media (max-width: 480px) {
  header { padding: 10px; }
  .card { padding: 10px;
  }
  .card .station-logo { width: 36px; height: 36px; }
  .station-logo-large {
    width: 20vh;
    height: 20vh;
    min-width: 120px;
    min-height: 120px;
  }
  #station-name { font-size: 18px; }
  .navigation-controls { gap: 20px;
  }
  .navigation-controls .nav-button {
    width: 45px;
    height: 45px;
    font-size: 18px;
  }
  .volume-container {
    max-width: 240px;
    gap: 8px;
  }
}
</style>
</head>
<body>
<header>
  <h1>MDFM</h1>
  <div class="search">
    <i class="fas fa-search"></i>
    <input type="text" id="search" placeholder="Поиск станции..." />
  </div>
</header>

<div class="grid" id="station-list">
  <div class="loading">
    <i class="fas fa-sync fa-spin"></i>
    <p>Загрузка радиостанций...</p>
  </div>
</div>

<div id="mini-player">
  <div class="mini-info">
    <div class="mini-logo" id="mini-logo"></div>
    <div class="mini-title" id="mini-title">Станция</div>
  </div>
  <div class="mini-controls">
    <button class="mini-play-toggle" id="mini-play-toggle">
      <i class="fas fa-play" id="mini-play-icon"></i>
    </button>
  </div>
</div>

<div id="player-fullscreen">
  <div class="back" onclick="closeFullscreen()">
    <i class="fas fa-chevron-down"></i>
  </div>
  <div class="player-content">
 
    <div class="station-logo-large" id="station-logo-large"></div>
    <div id="station-name">Название станции</div>
    <div class="navigation-controls">
      <div class="nav-button" id="prev-station" onclick="changeStation(-1)">
        <i class="fas fa-step-backward"></i>
      </div>
      <div class="play-button" id="play-toggle">
        <i class="fas fa-play" id="play-icon"></i>
      </div>
      <div class="nav-button" id="next-station" onclick="changeStation(1)">
        <i class="fas fa-step-forward"></i>
      </div>
    </div>
    <div class="volume-container">
      <i class="fas fa-volume-down"></i>
      <div class="volume-slider">
        <input type="range" min="0" max="1" step="0.05" value="1" id="volume-slider">
      </div>
      <i class="fas fa-volume-up"></i>
    </div>
  </div>
</div>

<div id="custom-error" class="custom-error">
  <div class="custom-error-content">
    <p id="custom-error-message"></p>
  </div>
</div>

<audio id="audio" autoplay hidden></audio>

<script>
const PLAYLIST_URL = 'https://tvmoldova.github.io/playlist.json';
const CACHE_KEY = 'radio_playlist_cache';

const grid = document.getElementById("station-list");
const search = document.getElementById("search");
const audio = document.getElementById("audio");
const miniPlayer = document.getElementById("mini-player");
const miniTitle = document.getElementById("mini-title");
const miniLogo = document.getElementById("mini-logo");
const miniPlayToggle = document.getElementById("mini-play-toggle");
const miniPlayIcon = document.getElementById("mini-play-icon");
const stationName = document.getElementById("station-name");
const stationLogoLarge = document.getElementById("station-logo-large");
const fullscreen = document.getElementById("player-fullscreen");
const playToggle = document.getElementById("play-toggle");
const playIcon = document.getElementById("play-icon");
const volumeSlider = document.getElementById("volume-slider");
const customError = document.getElementById("custom-error");
const customErrorMessage = document.getElementById("custom-error-message");

let stations = [];
let currentStation = null;
let currentStationIndex = -1;
let errorTimeout = null;

// Функция для экранирования HTML
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return String(unsafe)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

async function loadPlaylist() {
  try {
    const response = await fetch(PLAYLIST_URL + '?t=' + new Date().getTime());
    if (!response.ok) throw new Error('Ошибка сети, попытка загрузить из кэша');
    stations = await response.json();
    renderStations();
    const cache = { data: stations, timestamp: Date.now() };
    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
  } catch (error) {
    console.warn(error.message);
    const cachedData = localStorage.getItem(CACHE_KEY);
    if (cachedData) {
      console.log('Загрузка плейлиста из кэша.');
      const { data } = JSON.parse(cachedData);
      stations = data;
      renderStations();
    } else {
      console.error('Ошибка загрузки плейлиста и отсутствие кэша.');
      grid.innerHTML = `
      <div class="error">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Не удалось загрузить плейлист</p>
        <button onclick="refreshPlaylist()" style="background: var(--bg-element); border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 8px; margin-top: 15px; cursor: pointer; transition: all 0.3s ease;">Повторить</button>
      </div>`;
    }
  }
}

function refreshPlaylist() {
  localStorage.removeItem(CACHE_KEY);
  grid.innerHTML = `
    <div class="loading">
      <i class="fas fa-sync fa-spin"></i>
      <p>Обновление списка станций...</p>
    </div>`;
  loadPlaylist();
}

function renderStations(filter = "") {
  if (!stations || stations.length === 0) {
    grid.innerHTML = `
      <div class="error">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Нет доступных станций</p>
      </div>`;
    return;
  }

  const lowerCaseFilter = filter.toLowerCase();
  const filtered = stations.filter(s =>
    s.name.toLowerCase().includes(lowerCaseFilter) ||
    (s.genre && s.genre.toLowerCase().includes(lowerCaseFilter))
  );

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="no-results">
        <i class="fas fa-search"></i>
        <p>Станций не найдено</p>
      </div>`;
    return;
  }

  grid.innerHTML = "";
  filtered.forEach(station => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.stationId = station.id;
    card.tabIndex = -1;

    const escapedName = escapeHtml(station.name);
    let logoContent;
    if (station.logo) {
      const escapedLogo = escapeHtml(station.logo);
      logoContent = `<img src="${escapedLogo}" alt="${escapedName}" draggable="false" oncontextmenu="return false;" onerror="handleImageError(this)">`;
    } else {
      logoContent = `<i class="fas fa-radio"></i>`;
    }

    card.innerHTML = `
      <div class="station-logo">${logoContent}</div>
      <div class="station-info">
        <h3>${escapedName}</h3>
      </div>
    `;

    card.onclick = () => {
      card.blur();
      // Если это текущая станция и она уже играет, то ставим на паузу
      if (currentStation && currentStation.id === station.id) {
        if (!audio.paused) {
          audio.pause();
        } else {
          audio.play().catch(e => console.error("Ошибка воспроизведения:", e));
        }
      } else {
        // Если это другая станция, запускаем ее
        playStation(station);
      }
    };
    grid.appendChild(card);
  });
}

function handleImageError(img) {
  img.onerror = null;
  const container = img.parentElement;
  if (container) {
    container.innerHTML = `<i class="fas fa-radio"></i>`;
  }
}

function updateCardLoader(stationId, show) {
  const existingLoader = grid.querySelector('.card-loader');
  if (existingLoader) {
    existingLoader.remove();
  }

  if (show && stationId) {
    const card = grid.querySelector(`.card[data-station-id='${stationId}']`);
    if (card) {
      const loader = document.createElement("div");
      loader.className = "card-loader";
      card.appendChild(loader);
    }
  }
}

function playStation(station) {
  if (!station || !station.stream) return;
  if (audio.src) {
    audio.pause();
  }

  currentStation = station;
  currentStationIndex = stations.findIndex(s => s.id === station.id);
  
  updateCardLoader(station.id, true);

  miniPlayer.style.display = "flex";
  updatePlayerUI(station);
  
  initMediaSession(station);

  audio.src = station.stream;
  audio.play().then(() => {
    updateCardLoader(null, false);
    updatePlayIcons(true);
  }).catch(error => {
    console.error('Ошибка воспроизведения:', error);
    updateCardLoader(station.id, false);
    updatePlayIcons(false);
    handleStreamError();
  });
}

function initMediaSession(station) {
  if ('mediaSession' in navigator) {
    try {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: station.name,
        artist: 'MDFM Radio',
        artwork: station.logo ? [{ src: station.logo, sizes: '256x256' }] : []
      });
      navigator.mediaSession.setActionHandler('play', function() { togglePlay(); });
      navigator.mediaSession.setActionHandler('pause', function() { togglePlay(); });
      navigator.mediaSession.setActionHandler('previoustrack', function() { changeStation(-1); });
      navigator.mediaSession.setActionHandler('nexttrack', function() { changeStation(1); });
      navigator.mediaSession.playbackState = audio.paused ? 'paused' : 'playing';
    } catch (error) {
      console.error('Ошибка Media Session API:', error);
    }
  }
}

function handleStreamError() {
  if (!currentStation) return;

  const stationName = currentStation.name;
  showCustomError(`Станция "${stationName}" недоступна. Включаем следующую.`);

  clearTimeout(errorTimeout);
  errorTimeout = setTimeout(() => {
    closeCustomError();
    changeStation(1);
  }, 2500);
}

function updatePlayerUI(station) {
  miniTitle.textContent = station.name;
  stationName.textContent = station.name;
  updateLogo(miniLogo, station.logo);
  updateLogo(stationLogoLarge, station.logo);
}

function updateLogo(container, logoUrl) {
  container.innerHTML = '';
  if (logoUrl) {
    const img = document.createElement('img');
    img.src = logoUrl;
    img.alt = currentStation?.name || 'Radio logo';
    img.draggable = false;
    img.oncontextmenu = (e) => e.preventDefault();
    img.onerror = function() {
      container.innerHTML = '<i class="fas fa-radio"></i>';
    };
    container.appendChild(img);
  } else {
    container.innerHTML = '<i class="fas fa-radio"></i>';
  }
}

function togglePlay() {
  if (!currentStation) return;
  if (audio.paused) {
    audio.play().catch(e => console.error("Ошибка воспроизведения:", e));
  } else {
    audio.pause();
  }
}

function updatePlayIcons(isPlaying) {
  const iconClass = isPlaying ? "fas fa-pause" : "fas fa-play";
  playIcon.className = iconClass;
  miniPlayIcon.className = iconClass;
  if ('mediaSession' in navigator) {
    navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
  }
}

function changeStation(direction) {
  if (stations.length === 0 || currentStationIndex === -1) return;
  let newIndex = currentStationIndex + direction;
  if (newIndex < 0) newIndex = stations.length - 1;
  if (newIndex >= stations.length) newIndex = 0;
  
  playStation(stations[newIndex]);
}

function openFullscreen() {
  fullscreen.style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeFullscreen() {
  fullscreen.style.display = "none"; 
  document.body.style.overflow = "auto";
}

function showCustomError(message) {
  customErrorMessage.textContent = message;
  customError.classList.add('show');
}

function closeCustomError() {
  customError.classList.remove('show');
}

function init() {
  loadPlaylist();

  // Запрет контекстного меню на логотипах
  grid.addEventListener('contextmenu', function(e) {
    if (e.target.closest('.station-logo, .mini-logo, .station-logo-large')) {
      e.preventDefault();
    }
  });
  
  miniLogo.addEventListener('contextmenu', e => e.preventDefault());
  stationLogoLarge.addEventListener('contextmenu', e => e.preventDefault());
  
  // Запрет перетаскивания для всех изображений
  document.querySelectorAll('img').forEach(img => {
    img.draggable = false;
  });

  playToggle.addEventListener("click", togglePlay);

  miniPlayToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    togglePlay();
  });

  miniPlayer.addEventListener("click", (e) => {
    if (!e.target.closest('.mini-play-toggle')) openFullscreen();
  });
  
  search.addEventListener("input", () => renderStations(search.value));
  volumeSlider.addEventListener("input", () => audio.volume = volumeSlider.value);
  
  audio.volume = volumeSlider.value;

  audio.addEventListener("play", () => updatePlayIcons(true));
  audio.addEventListener("pause", () => updatePlayIcons(false));
  audio.addEventListener("ended", () => updatePlayIcons(false));
  audio.addEventListener("error", handleStreamError);

  // Логика для управления эффектом нажатия на кнопках
  const prevStationBtn = document.getElementById("prev-station");
  const nextStationBtn = document.getElementById("next-station");
  const buttonsToAnimate = [prevStationBtn, nextStationBtn, playToggle];

  buttonsToAnimate.forEach(button => {
    const addActive = () => button.classList.add('active-state');
    const removeActive = () => button.classList.remove('active-state');

    button.addEventListener('mousedown', addActive);
    button.addEventListener('touchstart', addActive, { passive: true });

    button.addEventListener('mouseup', removeActive);
    button.addEventListener('mouseleave', removeActive);
    button.addEventListener('touchend', removeActive);
  });
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>